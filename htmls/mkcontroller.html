<!DOCTYPE html>
<head>
<meta charset="utf-8" name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>Snaker Control</title>
<style>
        html {
			height: 100%;
			overflow: hidden;
		}
		body {
			height: 100%;
			overflow: hidden;
			margin:0;
			padding:0;
		}
		.ctrlb {
		    position: absolute;
		    border: 1px solid black;
		    width: 100px;
		    height: 100px;
		}
		#clientid {
		    position: absolute;
		    left: 110px;
		    top: 120px;
		    border: 1px solid black;
		    width: 100px;
		    height: 100px;
		    text-align: center;
            line-height: 100px;
		}
</style>
<script language="javascript" type="text/javascript">

  var wsUri = "ws://"+location.host+"/";
  var myclientid = 0;
  
  function startClient()
  {    
    websocket = new WebSocket(wsUri,"mkmouse");
    websocket.onopen = function(evt) { onOpen(evt) };
    websocket.onclose = function(evt) { onClose(evt) };
    websocket.onmessage = function(evt) { onMessage(evt) };
    websocket.onerror = function(evt) { onError(evt) };
  }

  function RegisterClient()
  {
    if(localStorage.snakeclientid !== undefined) {
        myclientid = localStorage.snakeclientid;
        document.getElementById("clientid").innerHTML = "Client: "+myclientid;
    } else {
        var regmessage = '{ "type": "game", "subtype": "reg", "clientid": '+myclientid+' }\0';
        websocket.send(regmessage);
    }
  }
  
  function UnregisterClient()
  {
    localStorage.clear();
    var regmessage = '{ "type": "game", "subtype": "quit", "clientid": '+myclientid+' }\0';
    websocket.send(regmessage);
    websocket.close();
  }
  
  function onOpen(evt)
  {
    console.log("Websocket opened...");
    RegisterClient();
    
    document.getElementById("left").addEventListener("touchstart", function (evt) {
        var message = '{ "type": "event", "subtype": "left", "clientid": '+myclientid+' }\0';
        websocket.send(message);
    }, false);
    
    document.getElementById("right").addEventListener("touchstart", function (evt) {
        var message = '{ "type": "event", "subtype": "right", "clientid": '+myclientid+' }\0';
        websocket.send(message);
    }, false);

    document.getElementById("up").addEventListener("touchstart", function (evt) {
        var message = '{ "type": "event", "subtype": "up", "clientid": '+myclientid+' }\0';
        websocket.send(message);
    }, false);

    document.getElementById("down").addEventListener("touchstart", function (evt) {
        var message = '{ "type": "event", "subtype": "down", "clientid": '+myclientid+' }\0';
        websocket.send(message);
    }, false);
    
    document.getElementById("clientid").addEventListener("click", function (evt) {
        var quitconfirm = confirm("Quit Snaker?");
        if(quitconfirm) {
            UnregisterClient();
        }
    }, false);    
  }

  function onClose(evt)
  {
    console.log("Websocket disconnected...");
  }

  function onMessage(evt)
  {
    var inmsg = JSON.parse(evt.data);
    if(inmsg.type == "game") {
        myclientid = inmsg.clientid;
        if(inmsg.clientid !== 170) {
            localStorage.snakeclientid = myclientid;
            document.getElementById("clientid").innerHTML = "Client: "+myclientid;
        }
    }
    console.log("Received: "+evt.data);
  }

  function onError(evt)
  {
    console.log("Error occured...");
  }
  
</script>
<head>
<body onload="startClient()">
<div id="clientid">Client:</div>
<div id="left" class="ctrlb" style="left: 5px; top: 120px;"></div>
<div id="right" class="ctrlb" style="left: 215px; top: 120px;"></div>
<div id="up" class="ctrlb" style="left: 110px; top: 15px;"></div>
<div id="down" class="ctrlb" style="left: 110px; top: 225px;"></div>
</body>
</html> 
